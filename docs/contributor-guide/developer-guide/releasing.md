# Releasing

See [Upgrading to a New Release](it-manual/sre-playbook/upgrading-to-a-new-release.md) for an overview of CiviForm release practices.

Releases are created weekly by the on-call engineer, usually on Wednesday, or if requested by a civic entity (e.g. for an urgent bugfix).

## Creating a new release

### 1. Find the most recent commit that is passing CI for all staging environments:

Find the commit SNAPSHOT id from one of the following, and extract the SHA from it. The SHA is the middle item in the SNAPSHOT-sha-hash ID

#### From Deployment-bot

Check the #deployment-bot Slack channel for the latest successful SNAPSHOT for Azure and AWS.  This offers a history of previous auto pushes too.

#### From Staging servers

On the running servers inspect the DOM tree for `<head><meta name="civiform-build-tag">`. Its `content` attribute will only show the current SNAPSHOT for each though.

* [staging-azure](https://staging-azure.civiform.dev/)
* [staging-AWS](https://staging-aws.civiform.dev/)


Note: If possible finding a commit that passes the above AND [Seattle staging](https://staging.seattle.civiform.com/) is great but not a requirement.  You'll have to inspect the DOM as in the 'From Staging server' section to find its version.

### 2. Run the script to create a new release

You'll need to determine:

* Commit SHA: This is the middle item in the SNAPSHOT-sha-hash ID from Step 1
* Release number: Pick the next minor number (1.X.0) since the [last release](https://github.com/civiform/civiform/releases)

Setup:
* Login to docker as the civiform user. If you don't have the password ask the #github-maintainers Slack channel
* Generate a GH access token and provide it as [documented](https://github.com/civiform/civiform/blob/main/bin/create-release#L14).

When ready run: [/bin/create-release](https://github.com/civiform/civiform/blob/main/bin/create-release) SHA vNumber

The release script will then:

1. Validates the commit SHA is a commit on main and RELEASE_NUMBER matches the convention
1. Tags the git commit with the release number, annotated with description that includes the email address of the release caller, and pushes it to github
1. Pulls the existing server image from Docker Hub (identified by the commit SHA), tags it with the release number and pushes it to Docker Hub
1. Calls the GitHub API to create a new draft release
1. Prints the GH URL to the draft release


### 3. Edit the generated draft release

Follow the GitHub URL to the draft release printed at the end of the script from the previous step, or navigate to [the repo's releases page](https://github.com/civiform/civiform/releases) and find the new draft release.

Next, edit the release notes to include the following:

- Description of fixed bugs
- Description of new features
- Database schema changes
- Other stateful changes (such as stored file key name schema)
- API version changes and deprecation notices
- New configuration values
- Infrastructure changes
- Dependency changes (for the server only) including new, removed, and version updates

Every pull request that is relevant to the release should have a `Release notes` section in its description, use this if the autogenerated description for a given PR is not adequate.

### Publish the release and email all stakeholders

Once the release notes are looking good, publish the draft release and then email the release notes to civiform-technical@googlegroups.com
